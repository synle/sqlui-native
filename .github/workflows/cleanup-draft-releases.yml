name: Cleanup Draft Releases

on:
  workflow_dispatch:
    inputs:
      keep_count:
        description: "Number of most recent draft releases to keep"
        type: number
        default: 0

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Delete old draft releases (keeping last ${{ inputs.keep_count }})
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up old draft releases, keeping the last ${{ inputs.keep_count }}..."
          gh release list --json tagName,isDraft --limit 100 | \
            jq -r '[.[] | select(.isDraft == true)] | sort_by(.tagName) | reverse | .[${{ inputs.keep_count }}:] | .[].tagName' | \
            while read -r tag; do
              echo "Deleting draft release: $tag"
              gh release delete "$tag" --yes --cleanup-tag || true
            done
