name: Package

on:
  workflow_call:
    inputs:
      node_version:
        type: string
        default: "20"
        description: "Node.js version"
      release_mode:
        type: string
        default: "no_release"
        description: "Release mode: draft, production, or no_release"
      run_format:
        type: boolean
        default: false
        description: "Whether to run code formatting and commit"
      draft_keep_count:
        type: number
        default: 5
        description: "Number of most recent draft releases to keep during cleanup"
    secrets:
      TOKEN:
        required: false
    outputs:
      dist_version:
        value: ${{ jobs.create_release.outputs.dist_version }}

jobs:
  code_format:
    runs-on: ubuntu-latest
    steps:
      - name: Print input parameters
        run: |
          echo "node_version: ${{ inputs.node_version }}"
          echo "release_mode: ${{ inputs.release_mode }}"
          echo "run_format: ${{ inputs.run_format }}"

      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Run code formatting
        run: bash scripts/format.sh

      - name: Commit formatting changes
        if: ${{ inputs.run_format }}
        id: commit
        uses: EndBug/add-and-commit@v9
        with:
          message: "CI / CD - Format code"
          default_author: github_actions

  create_release:
    if: ${{ inputs.release_mode != 'no_release' }}
    needs: [code_format]
    runs-on: ubuntu-latest
    outputs:
      dist_version: ${{ steps.package-version.outputs.current-version }}
      release_upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Stamp version (${{ inputs.release_mode }})
        run: |
          echo "::group::Version stamp - release_mode=${{ inputs.release_mode }}"
          if [ "${{ inputs.release_mode }}" = "production" ]; then
            npm run version-stamp:release
          else
            npm run version-stamp:draft
          fi
          echo "::endgroup::"

      - name: Get package version
        id: package-version
        uses: martinbeentjes/npm-get-version-action@master
        with:
          path: "."

      - name: Delete existing tag and release
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          delete_release: true
          tag_name: "${{ steps.package-version.outputs.current-version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub release
        uses: actions/create-release@v1
        id: create_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.package-version.outputs.current-version }}
          release_name: ${{ steps.package-version.outputs.current-version }}
          body: |
            Release ${{ steps.package-version.outputs.current-version }}
          draft: ${{ inputs.release_mode == 'draft' }}
          prerelease: ${{ inputs.release_mode == 'draft' }}

      - name: Cleanup old draft releases
        if: ${{ inputs.release_mode == 'draft' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Cleaning up old draft releases, keeping the last ${{ inputs.draft_keep_count }}..."
          gh release list --json tagName,isDraft --limit 100 | \
            jq -r '[.[] | select(.isDraft == true)] | sort_by(.tagName) | reverse | .[${{ inputs.draft_keep_count }}:] | .[].tagName' | \
            while read -r tag; do
              echo "Deleting old draft release: $tag"
              gh release delete "$tag" --yes --cleanup-tag || true
            done

  prebuild:
    needs: [code_format]
    runs-on: ubuntu-latest
    name: Build, Smoke Test and Code Format
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Run tests
        run: bash scripts/test.sh

  dist_windows_x64:
    needs: [prebuild, create_release]
    if: ${{ always() && needs.prebuild.result == 'success' }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Build application
        run: bash scripts/build.sh

      - name: Package Windows x64 exe
        run: |
          npm run dist-win-x64
          ls -R ./dist
          mv "./dist/sqlui-native Setup*.exe" ./dist/sqlui-native-x64.exe

      - name: Upload x64 exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows 10 - 11 (Intel - AMD x64).exe
          path: ./dist/sqlui-native-x64.exe
          compression-level: 9

      - name: Upload x64 exe to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native-x64.exe
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}-x64.exe
          asset_content_type: application/octet-stream

      - name: Package Windows x64 appx
        run: |
          npm run dist-win32-appx
          mv ./dist/sqlui-native*.appx ./dist/sqlui-native.appx

      - name: Upload x64 appx artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows 10 - 11 (Intel - AMD x64).appx
          path: ./dist/sqlui-native.appx
          compression-level: 9

      - name: Upload x64 appx to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native.appx
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}.appx
          asset_content_type: application/octet-stream

  dist_windows_arm64:
    needs: [prebuild, create_release]
    if: ${{ always() && needs.prebuild.result == 'success' }}
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Install setuptools for node-gyp
        run: pip install setuptools

      - name: Build application
        run: bash scripts/build.sh

      - name: Package Windows ARM64 exe
        run: |
          npm run dist-win-arm64
          ls -R ./dist
          mv "./dist/sqlui-native Setup*.exe" ./dist/sqlui-native-arm64.exe

      - name: Upload ARM64 exe artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows 10 - 11 (ARM architecture).exe
          path: ./dist/sqlui-native-arm64.exe
          compression-level: 9

      - name: Upload ARM64 exe to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native-arm64.exe
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}-arm64.exe
          asset_content_type: application/octet-stream

  dist_macos_arm64:
    needs: [prebuild, create_release]
    if: ${{ always() && needs.prebuild.result == 'success' }}
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Build application
        run: bash scripts/build.sh

      - name: Package macOS ARM64 dmg
        run: |
          npm run dist-macos-arm64
          find ./dist
          mv ./dist/sqlui*.dmg ./dist/sqlui-native-arm64.dmg

      - name: Upload ARM64 dmg artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS - OSX (Apple Silicon M-Series).dmg
          path: ./dist/sqlui-native-arm64.dmg
          compression-level: 9

      - name: Upload ARM64 dmg to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native-arm64.dmg
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}-arm64.dmg
          asset_content_type: application/octet-stream

  dist_macos_intel_x64:
    needs: [prebuild, create_release]
    if: ${{ always() && needs.prebuild.result == 'success' }}
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Build application
        run: bash scripts/build.sh

      - name: Package macOS x64 dmg
        run: |
          npm run dist-macos-x64
          find ./dist
          mv ./dist/sqlui*.dmg ./dist/sqlui-native-x64.dmg

      - name: Upload x64 dmg artifact
        uses: actions/upload-artifact@v4
        with:
          name: macOS - OSX (Intel x64).dmg
          path: ./dist/sqlui-native-x64.dmg
          compression-level: 9

      - name: Upload x64 dmg to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native-x64.dmg
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}-x64.dmg
          asset_content_type: application/octet-stream

  dist_linux:
    needs: [prebuild, create_release]
    if: ${{ always() && needs.prebuild.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Build application
        run: bash scripts/build.sh

      - name: Package Linux distributables
        run: |
          npm run dist
          npm run dist-linux-appimage
          find ./dist
          mv ./dist/sqlui*.deb ./dist/sqlui-native.deb
          mv ./dist/sqlui*.rpm ./dist/sqlui-native.rpm
          mv ./dist/sqlui*.snap ./dist/sqlui-native.snap
          mv ./dist/sqlui*.pacman ./dist/sqlui-native.pacman
          mv ./dist/sqlui*.AppImage ./dist/sqlui-native.AppImage

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux - Debian Ubuntu.deb
          path: ./dist/sqlui-native.deb
          compression-level: 9

      - name: Upload deb to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native.deb
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}.deb
          asset_content_type: application/octet-stream

      - name: Upload rpm artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux - Redhat CentOS Fedora.rpm
          path: ./dist/sqlui-native.rpm
          compression-level: 9

      - name: Upload rpm to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native.rpm
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}.rpm
          asset_content_type: application/octet-stream

      - name: Upload snap artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux - Ubuntu.snap
          path: ./dist/sqlui-native.snap
          compression-level: 9

      - name: Upload snap to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native.snap
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}.snap
          asset_content_type: application/octet-stream

      - name: Upload pacman artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux - Arch.pacman
          path: ./dist/sqlui-native.pacman
          compression-level: 9

      - name: Upload pacman to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native.pacman
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}.pacman
          asset_content_type: application/octet-stream

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux.AppImage
          path: ./dist/sqlui-native.AppImage
          compression-level: 9

      - name: Upload AppImage to release
        if: ${{ needs.create_release.outputs.release_upload_url != '' }}
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.release_upload_url }}
          asset_path: ./dist/sqlui-native.AppImage
          asset_name: sqlui-native-${{ needs.create_release.outputs.dist_version }}.AppImage
          asset_content_type: application/octet-stream

  roll_back_on_failure_or_canceled:
    if: ${{ always() && inputs.release_mode != 'no_release' && needs.create_release.result == 'success' && (needs.dist_windows_x64.result == 'failure' || needs.dist_windows_arm64.result == 'failure' || needs.dist_macos_arm64.result == 'failure' || needs.dist_macos_intel_x64.result == 'failure' || needs.dist_linux.result == 'failure' || needs.dist_windows_x64.result == 'cancelled' || needs.dist_windows_arm64.result == 'cancelled' || needs.dist_macos_arm64.result == 'cancelled' || needs.dist_macos_intel_x64.result == 'cancelled' || needs.dist_linux.result == 'cancelled') }}
    needs: [create_release, dist_windows_x64, dist_windows_arm64, dist_macos_arm64, dist_macos_intel_x64, dist_linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Delete failed release tag and assets
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          delete_release: true
          tag_name: "${{ needs.create_release.outputs.dist_version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    if: ${{ inputs.release_mode == 'production' }}
    needs: [create_release, dist_windows_x64, dist_windows_arm64, dist_macos_arm64, dist_macos_intel_x64, dist_linux]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"

      - name: Update package.json to release version
        run: npm version --no-git-tag-version "${{ needs.create_release.outputs.dist_version }}"

      - name: Write release version file
        run: |
          echo "{ \"version\": \"${{ needs.create_release.outputs.dist_version }}\" }" > release.json

      - name: Commit release version
        uses: EndBug/add-and-commit@v9
        with:
          message: "CI / CD - New Release ${{ needs.create_release.outputs.dist_version }}"
          default_author: github_actions
